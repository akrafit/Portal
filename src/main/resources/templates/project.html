<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link th:href="@{/css/project.css}" rel="stylesheet" type="text/css">
    <title>–ü—Ä–æ–µ–∫—Ç - Web Portal</title>
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="logo">–ü–æ—Ä—Ç–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞–º–∏</div>
        <div class="nav-links">
            <a th:href="@{/projects}" class="btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º</a>
            <a th:href="@{/projects}">üìã –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</a>
            <a sec:authorize="hasAnyRole('ADMIN')" th:href="@{/admin}" >‚öô –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            <div class="user-info">
                <span th:text="${user.name}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                <div class="user-avatar">
                    <span>U</span>
                </div>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit" class="logout-btn">–í—ã–π—Ç–∏</button>
                </form>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container">
    <!-- Flash —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div th:if="${success}" class="alert-success" id="flashSuccess">
        <span th:text="${success}">–£—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
    </div>
    <div th:if="${error}" class="alert-error" id="flashError">
        <span th:text="${error}">–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ</span>
    </div>

    <!-- Header -->
    <div class="header">
        <h1 class="page-title" th:text="${project.createdBy.name}">üìÅ –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h1>
        <div class="btn-group">
            <button class="btn">–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞</button>
            <button class="btn btn-secondary">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</button>
        </div>
    </div>

    <!-- Project Information -->
    <div class="project-info">
        <div class="project-header">
            <div>
                <h2 class="project-title" th:text="${project.name}">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç–∞</h2>
                <p class="project-description" th:text="${project.getDescription()}">
                    –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
                    –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–±–æ—Ä–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤.
                </p>
            </div>
            <div class="project-status">
                <h2 class="badge" th:if="${project.getGeneral() != null}" th:text="${project.getGeneral().getName()}"></h2>
            </div>
        </div>

        <div class="project-meta">
            <div class="meta-item">
                <div class="meta-label">–°–æ–∑–¥–∞–Ω</div>
                <div class="meta-value" th:text="${T(com.portal.service.DateUtils).format(project.getCreatedAt())}">15.12.2023</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">–ê–≤—Ç–æ—Ä</div>
                <div class="meta-value" th:text="${project.createdBy.name}">–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤</div>
                <div class="meta-value" th:text="${size}">8</div>
            </div>
            <div class="meta-item">
                <div class="meta-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                <div class="meta-value" th:text="${T(com.portal.service.DateUtils).format(project.getCreatedAt())}">20.12.2023 14:30</div>
            </div>
        </div>
    </div>

    <!-- Files List -->
    <div class="files-section">
        <div class="section-title">
            <span>üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã</span>
            <span class="badge" th:text="${sectionStatuses.size()}"></span>
        </div>

        <div class="card-body">
            <div th:if="${sectionStatuses.isEmpty()}" class="text-center py-4">
                <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤</p>
            </div>

            <div th:unless="${sectionStatuses.isEmpty()}" class="sections-grid">
                <div th:each="sectionStatus : ${sectionStatuses}" class="section-card">
                    <div class="section-header">
                        <h4 class="section-name" th:text="${sectionStatus.section.name}"></h4>
                        <span class="section-badge" th:classappend="${sectionStatus.badgeClass}"
                              th:text="${sectionStatus.statusText}"></span>
                    </div>

                    <!-- –ë–ª–æ–∫ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
                    <div class="assigned-users" th:if="${not sectionStatus.assignedUsers.isEmpty()}">
                        <div class="assignment-header">
                            <div class="meta-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ:</div>
                            <span class="assignment-count" th:text="${sectionStatus.assignedUsers.size()}"></span>
                        </div>
                        <div th:each="user : ${sectionStatus.assignedUsers}" class="assigned-user">
                            <span th:text="${user.name}"></span>
                        </div>
                    </div>
                    <div th:if="${sectionStatus.assignedUsers.isEmpty()}" class="assigned-users">
                        <div class="no-assignments">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</div>
                    </div>

                    <div class="section-actions">
                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ -->
                        <a th:href="@{/project/{projectId}/{sectionId}(projectId=${project.id}, sectionId=${sectionStatus.section.id})}"
                           class="btn btn-secondary btn-sm">
                            <span class="btn-icon">üëÅÔ∏è</span>
                            –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                        </a>

                        <form th:if="${isProjectCreator}" th:action="@{/projects/{projectId}/documents/sections/{sectionId}/generate(projectId=${project.id}, sectionId=${sectionStatus.section.id})}"
                              method="post" class="d-inline">
                            <button type="submit" class="btn-action btn-generate">
                                <span class="btn-icon" th:text="${sectionStatus.buttonIcon}"></span>
                                <span th:text="${sectionStatus.buttonText}"></span>
                            </button>
                        </form>

                        <!-- –§–æ—Ä–º–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –ø—Ä–æ–µ–∫—Ç–∞ —Å —Ä–æ–ª—å—é EMPLOYEE) -->
                        <div th:if="${isProjectCreator}" class="assignment-form">
                            <form th:action="@{/projects/{projectId}/documents/sections/{sectionId}/assign(projectId=${project.id}, sectionId=${sectionStatus.section.id})}"
                                  method="post" class="d-inline">
                                <select name="userId" class="form-control-sm">
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ --</option>
                                    <option th:each="contractor : ${availableContractors}"
                                            th:value="${contractor.id}"
                                            th:text="${contractor.name} + ' (' + ${contractor.email} + ')'">
                                    </option>
                                </select>
                                <button type="submit" class="btn-action btn-assign">
                                    <span class="btn-icon">üë§</span>
                                    –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ flash –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    document.addEventListener('DOMContentLoaded', function() {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º flash —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        const flashMessages = document.querySelectorAll('.alert-success, .alert-error');
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.remove();
            }, 5000);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const action = this.querySelector('button[type="submit"]').textContent.trim();
                if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ "${action}"?`)) {
                    e.preventDefault();
                }
            });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        document.querySelectorAll('.assignment-form form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const select = this.querySelector('select[name="userId"]');
                if (!select.value) {
                    e.preventDefault();
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return false;
                }

                const userName = select.options[select.selectedIndex].text;
                if (!confirm(`–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}" –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª?`)) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    });

    function showSectionInfo(sectionId) {
        alert(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–¥–µ–ª–µ ID: ${sectionId}\n–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–¥–µ–ª–µ.`);
    }
</script>
</body>
</html>