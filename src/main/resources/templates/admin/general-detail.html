<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${general.name} + ' - Детали'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <!-- Информация о General -->
    <div class="card mb-4">
        <div class="card-header">
            <h2 th:text="${general.name}"></h2>
        </div>
        <div class="card-body">
            <p><strong>Путь:</strong> <span th:text="${general.src}"></span></p>
            <a href="/admin/generals" class="btn btn-secondary">← Назад к списку</a>
        </div>
    </div>
    <!-- Навигация -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/admin/generals}">Генеральные</a></li>
            <li class="breadcrumb-item"><a th:href="@{/admin/generals/sections}">Разделы</a></li>
            <li class="breadcrumb-item active" th:text="${general.name}"></li>
        </ol>
    </nav>

    <!-- Форма добавления Главы -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Добавить новую Главу</h4>
        </div>
        <div class="card-body">
            <form th:action="@{/admin/generals/{id}/chapters(id=${general.id})}" method="post">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" th:field="*{chapterForm.name}"
                               placeholder="Название главы" required>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" th:field="*{chapterForm.src}"
                               placeholder="Путь" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success">Добавить Главу</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Таблица связей Глав с Разделами -->
    <!-- Таблица связей Глав с Разделами -->
    <div class="card">
        <div class="card-header">
            <h4>Привязка Глав к Разделам</h4>
            <p class="mb-0 text-muted">Отметьте чекбоксы и нажмите "Сохранить привязки"</p>
        </div>
        <div class="card-body">
            <form id="sectionsForm" th:action="@{/admin/generals/{id}/save-sections(id=${general.id})}" method="post">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>Глава</th>
                            <th th:each="section : ${sections}" th:text="${section.name}"></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="chapter : ${chapters}">
                            <td>
                                <strong th:text="${chapter.name}"></strong>
                                <br>
                                <small class="text-muted" th:text="${chapter.src}"></small>
                            </td>
                            <td th:each="section : ${sections}">
                                <div class="form-check">
                                    <input class="form-check-input section-checkbox"
                                           type="checkbox"
                                           name="chapterSections"
                                           th:value="${chapter.id} + '_' + ${section.id}"
                                           th:checked="${chapterSectionMap.get(chapter.id) != null && chapterSectionMap.get(chapter.id).contains(section.id)}">
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Кнопка сохранения изменений -->
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Сохранить привязки</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // JavaScript для обработки множественных чекбоксов
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.section-checkbox');

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const form = this.closest('form');
                const sectionIds = [];

                // Собираем все отмеченные чекбоксы для этой главы
                const row = this.closest('tr');
                const rowCheckboxes = row.querySelectorAll('.section-checkbox:checked');
                rowCheckboxes.forEach(cb => {
                    sectionIds.push(cb.previousElementSibling.value);
                });

                // Создаем скрытые input для всех выбранных sectionIds
                form.querySelectorAll('input[name="sectionIds"]').forEach(input => input.remove());
                sectionIds.forEach(sectionId => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'sectionIds';
                    hiddenInput.value = sectionId;
                    form.appendChild(hiddenInput);
                });

                form.submit();
            });
        });
    });

        // Функции для массового выделения/снятия чекбоксов
        function selectAllCheckboxes() {
        document.querySelectorAll('.section-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    }

        function deselectAllCheckboxes() {
        document.querySelectorAll('.section-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }

        // Подтверждение сохранения
        document.getElementById('sectionsForm').addEventListener('submit', function(e) {
        const checkedCount = document.querySelectorAll('.section-checkbox:checked').length;
        if (checkedCount > 0) {
        if (!confirm(`Сохранить привязки для ${checkedCount} отмеченных связей?`)) {
            e.preventDefault();
        }
    } else {
        if (!confirm('Все связи будут очищены. Продолжить?')) {
        e.preventDefault();
    }
    }
    });

        // Показываем сообщения об успехе/ошибке
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('success')) {
        alert('Привязки успешно сохранены!');
    } else if (urlParams.has('error')) {
        alert('Ошибка при сохранении привязок!');
    }

</script>
</body>
</html>